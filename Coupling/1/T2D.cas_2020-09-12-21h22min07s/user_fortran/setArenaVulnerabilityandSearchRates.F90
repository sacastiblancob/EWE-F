!========================================================================
! This file is part of EwE-F
! Copyright (C) 2011-2019 Middle East Technical University
! Institute of Marine Sciences (IMS-METU), Erdemli/Turkey and
! Istituto Nazionale di Oceanografia e di Geofisica Sperimentale (OGS),
! Trieste/Italy.
!
! This program is free software; you can redistribute it and/or modify
! it under the terms of the GNU General Public License version 2 as
! published by the Free Software Foundation.
!
! This program is distributed in the hope that it will be useful, but
! WITHOUT ANY WARRANTY; without even the implied warranty of
! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
! General Public License for more details.
!
! You should have received a copy of the GNU General Public License
! along with  this program; if not,
! see <http://www.gnu.org/licenses/gpl-2.0.html>.
!========================================================================

            subroutine setArenaVulnerabilityandSearchRates &
  (nvars, vrows, vcols, ep_data, ep_diet, es_data, es_vul, arena)

!#ifdef isWithBFM
!  use global_mem
!#else
  use statevartypesecopath, only: RLEN
!#endif

!use statevartypesecopath, only: ep_data, ep_diet
use statevartypesecopath, only: ecopath_data
!use statevartypesecosim, only: es_data, es_vul, arena
use statevartypesecosim, only: ecosim_data, arena_data

implicit none

! INTENT VARIABLES
integer, intent(in)             :: nvars, vrows, vcols
TYPE(ecopath_data), INTENT(IN)  :: ep_data(nvars)
REAL(RLEN), INTENT(IN)          :: ep_diet &
                              (nvars+1, count(ep_data(:)%org_type==2))
TYPE(ecosim_data), INTENT(IN)   :: es_data(nvars)
REAL(RLEN), INTENT(IN)          :: es_vul(vrows, vcols)
TYPE(arena_data), INTENT(INOUT) :: arena

! IN SUBROUTINE VARIABLES
integer             :: prey, pred
real(RLEN)          :: Dzero

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
do pred = 1, vcols
    do prey = 1, vrows
        arena%Q_arena(prey, pred) = 0
    end do
end do

do pred = 1, vcols
    do prey = 1, vrows
        if (es_vul(prey, pred) /= -999) then

            ! total consumptions of predators in arena
            arena%Q_link(prey, pred) = (ep_data(pred)%biomass &
              * ep_data(pred)%QoB * ep_diet(prey, pred)) !&
              !* es_data(pred)%Ftime

            arena%Q_arena(prey, pred) =  arena%Q_arena(prey, pred) &
              + arena%Q_link(prey, pred)

            ! setting of initial vulnerable biomasses
!#ifdef isWithBFM
!            arena%vul_arena(prey, pred) = (es_vul(prey, pred) &
!              + 0.0000000001D0) * arena%Q_arena(prey, pred) &
!              / ep_data(prey)%biomass
!#else
!!            arena%vul_arena(prey, pred) = real((es_vul(prey, pred) &
!!              + 0.0000000001D0) * arena%Q_arena(prey, pred) &
!!              / ep_data(prey)%biomass, 4)
            arena%vul_arena(prey, pred) = real((es_vul(prey, pred) &
              + 0.0000000001D0) * arena%Q_arena(prey, pred) &
              / ep_data(prey)%biomass, RLEN)
!#endif

            if (arena%vul_arena(prey, pred) == 0) then
                arena%vul_arena(prey, pred) = 1
            end if

!#ifdef isWithBFM
!            arena%vul_biom(prey, pred) = (es_vul(prey, pred) &
!              + 0.0000000001D0 - 1.0D0) * arena%Q_arena(prey, pred) &
!              / (2 * arena%vul_arena(prey, pred))
!#else
!!            arena%vul_biom(prey, pred) = real((es_vul(prey, pred) &
!!              + 0.0000000001D0 - 1.0D0) * arena%Q_arena(prey, pred) &
!!              / (2 * arena%vul_arena(prey, pred)), 4)
            arena%vul_biom(prey, pred) = real((es_vul(prey, pred) &
              + 0.0000000001D0 - 1.0D0) * arena%Q_arena(prey, pred) &
              / (2 * arena%vul_arena(prey, pred)), RLEN)
!#endif

            if (arena%vul_biom(prey, pred) == 0) then
                arena%vul_biom(prey, pred) = 1
            end if

            ! setting of predator search rates
            if (arena%vul_biom(prey, pred) > 0) then

                ! QBmaxQBo / (QbmaxQBo - 1)
                Dzero = es_data(pred)%QB_maxoQB_0 / (es_data(pred)%QB_maxoQB_0 - 1)

                arena%a_link(prey, pred) = Dzero &
                  * arena%Q_link(prey, pred) / &
                  (arena%vul_biom(prey, pred) * es_data(pred)%pred)
            else
                arena%a_link(prey, pred) = 0
            end if
        end if
    end do
end do

end subroutine setArenaVulnerabilityandSearchRates
